<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RescueLink HQ | Command & Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-red: #ff3b3b;
            --bg-dark: #05070a;
            --glass: rgba(17, 25, 40, 0.75);
        }

        body {
            background-color: var(--bg-dark);
            color: #f8fafc;
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-image: 
                radial-gradient(at 0% 0%, rgba(255, 59, 59, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(37, 99, 235, 0.05) 0px, transparent 50%);
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
        }

        .sos-pulse {
            position: relative;
        }
        .sos-pulse::before {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: var(--primary-red);
            border-radius: inherit;
            animation: ripple 2s infinite;
            z-index: -1;
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        .map-placeholder {
            background: linear-gradient(45deg, #0f172a 25%, #1e293b 50%, #0f172a 75%);
            background-size: 200% 200%;
            animation: gradientMove 10s ease infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <header class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-extrabold tracking-tighter italic">RESCUE<span class="text-red-500">LINK</span></h1>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-[0.3em]">Advanced Dispatch Interface v2.0</p>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="glass-card px-6 py-2 flex items-center gap-4">
                <div class="text-right">
                    <p class="text-[10px] text-slate-500 uppercase font-bold">System Time</p>
                    <p id="clock" class="font-mono text-xl font-bold text-red-500">00:00:00</p>
                </div>
            </div>
            <div class="h-12 w-12 rounded-2xl bg-gradient-to-tr from-red-600 to-orange-500 flex items-center justify-center shadow-lg shadow-red-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card p-5 border-l-4 border-red-500">
                    <p class="text-slate-400 text-[10px] uppercase font-bold mb-1">Active SOS</p>
                    <h3 id="count-val" class="text-3xl font-black">0</h3>
                </div>
                <div class="glass-card p-5 border-l-4 border-green-500">
                    <p class="text-slate-400 text-[10px] uppercase font-bold mb-1">Avg Response</p>
                    <h3 class="text-3xl font-black text-green-400">4.2<span class="text-sm font-medium ml-1">min</span></h3>
                </div>
            </div>

            <div class="glass-card overflow-hidden flex flex-col h-[450px]">
                <div class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-slate-300">Live GPS Tracker</h3>
                    <span class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-[10px] font-mono">SAT-LINK: ACTIVE</span>
                    </span>
                </div>
                <div class="flex-1 map-placeholder relative flex items-center justify-center group cursor-crosshair">
                    <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px); background-size: 30px 30px;"></div>
                    
                    <div class="text-center z-10 px-6">
                        <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 sos-pulse">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <p class="text-sm font-bold text-white mb-1">Monitoring Emergency Coordinates</p>
                        <p class="text-[10px] text-slate-400 font-mono tracking-tighter">Lat: --.---- | Lon: --.----</p>
                        <button class="mt-4 px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-[10px] uppercase font-bold transition-all">Expand Map</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xs font-black uppercase tracking-[0.3em] text-slate-400">Incoming Signal Stream</h2>
                <span class="text-[10px] font-mono text-slate-600 italic">Auto-refresh: 3s</span>
            </div>

            <div id="list" class="space-y-4">
                <div id="empty" class="glass-card py-24 text-center border-dashed">
                    <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <p class="text-slate-500 font-bold text-xs uppercase tracking-widest">Scanning Frequencies...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
    // Update Clock
    setInterval(() => { 
        document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'); 
    }, 1000);

    // List of resolved IDs to hide them from view (local "Resolved" state)
    let resolvedAlerts = JSON.parse(localStorage.getItem('resolved_alerts') || '[]');

    async function checkBridge() {
        const list = document.getElementById('list');
        const counter = document.getElementById('count-val');
        
        try {
            // Pointing to your actual Local Backend
            const response = await fetch('http://localhost:3000/api/alerts');
            const allAlerts = await response.json();

            // Filter out alerts that the hospital has marked as "Resolved"
            const alerts = allAlerts.filter(a => !resolvedAlerts.includes(a.ID));

            if (alerts.length > 0) {
                counter.innerText = alerts.length;
                list.innerHTML = ""; 
                
                alerts.forEach(sos => {
                    let icon = "‚ö†Ô∏è";
                    if(sos.EmergencyType.toLowerCase().includes('medical')) icon = "üöë";
                    if(sos.EmergencyType.toLowerCase().includes('fire')) icon = "üî•";
                    if(sos.EmergencyType.toLowerCase().includes('accident')) icon = "üöó";

                    // Fixing the Google Maps URL and the Resolve Button
                    list.innerHTML += `
                    <div id="alert-${sos.ID}" class="glass-card p-6 flex flex-col md:flex-row items-center gap-6 hover:border-red-500/50 transition-all group">
                        <div class="w-20 h-20 bg-red-500/10 rounded-3xl flex items-center justify-center text-4xl border border-red-500/20 group-hover:scale-110 transition-transform">
                            ${icon}
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="px-2 py-1 bg-red-500 text-[9px] font-black rounded uppercase">Priority 1</span>
                                <span class="text-[10px] font-mono text-slate-500">${new Date(sos.CreatedAt).toLocaleString()}</span>
                            </div>
                            <h2 class="text-2xl font-black text-white uppercase tracking-tight group-hover:text-red-400 transition-colors">${sos.EmergencyType}</h2>
                            <p class="text-sm font-medium text-slate-400">Caller: <span class="text-white">${sos.PatientName}</span></p>
                        </div>

                        <div class="flex flex-col gap-2 w-full md:w-auto">
                            <a href="https://www.google.com/maps?q=${sos.Latitude},${sos.Longitude}" target="_blank" 
                               class="bg-white text-black hover:bg-blue-500 hover:text-white px-6 py-3 rounded-2xl font-black text-xs transition-all uppercase text-center flex items-center justify-center gap-2">
                                Track on GPS
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                </svg>
                            </a>
                            <button onclick="resolveIssue(${sos.ID})" 
                               class="bg-green-600/20 text-green-500 hover:bg-green-600 hover:text-white px-6 py-3 rounded-2xl font-black text-xs transition-all uppercase text-center">
                                Mark Resolved
                            </button>
                        </div>
                    </div>`;
                });
            } else {
                counter.innerText = "0";
                list.innerHTML = `
                    <div class="glass-card py-24 text-center border-dashed">
                        <p class="text-slate-500 font-bold text-xs uppercase tracking-widest">All Clear - No Active SOS</p>
                    </div>`;
            }
        } catch (e) { 
            console.log("Waiting for Backend..."); 
        }
    }

    // Function to "Resolve" and hide an alert
    function resolveIssue(id) {
        if(confirm("Confirm emergency resolved? This will remove it from the dashboard.")) {
            resolvedAlerts.push(id);
            localStorage.setItem('resolved_alerts', JSON.stringify(resolvedAlerts));
            checkBridge(); // Refresh view
        }
    }

    setInterval(checkBridge, 3000);
    checkBridge();
</script>
</body>
</html>
